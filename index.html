<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>鸣潮伤害分析与声骸词条对比工具 1.4</title>
    <script src="lib/chart.js"></script>
    <script src="lib/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <div class="top-buttons">
        <div class="export-dropdown">
            <button class="btn export-btn export-btn-save" onclick="toggleExportMenu()">
                💾 保存配置 ▼
            </button>
            <div class="export-menu" id="exportMenu">
                <a href="javascript:void(0)" onclick="saveConfig(true, 'json')">保存并导出JSON文件</a>
                <a href="javascript:void(0)" onclick="saveConfig(true, 'xlsx')">保存并导出Excel文件</a>
                <a href="javascript:void(0)" onclick="saveConfig()">仅保存到本地存储</a>
            </div>
        </div>
        <div class="import-dropdown">
            <button class="btn import-btn" onclick="toggleImportMenu()">
                📂 导入配置 ▼
            </button>
            <div class="import-menu" id="importMenu">
                <a href="javascript:void(0)" onclick="loadConfig()">从本地存储加载</a>
                <a href="javascript:void(0)" onclick="triggerFileImport()">从文件导入</a>
            </div>
        </div>
        <input type="file" id="csvImport" class="hidden-file-input" onchange="importFullData(this)" accept=".json,.xlsx,.xls">
        <button class="btn reset-btn" onclick="resetToDefaults()">
            🔄 重置到默认
        </button>
    </div>

    <div class="grid">
        <div class="panel">
            <h2>1. 核心属性 (面板)</h2>
            <div class="input-row"><label>基础生命 / 总生命</label>
            <div><input type="number" id="base_hp" value="10000" style="width:60px"> / <input type="number" id="total_hp_now" value="20000" style="width:60px"></div></div>
            <div class="input-row"><label>基础攻击(角色+武器)</label><input type="number" id="base_atk" value="1000" style="width:70px"></div>
            <div class="input-row"><label>当前面板总攻击</label><input type="number" id="total_atk_now" value="2500" style="width:70px"></div>
            <div class="input-row"><label>基础防御 / 总防御</label>
            <div><input type="number" id="base_def" value="1000" style="width:50px"> / <input type="number" id="total_def_now" value="1500" style="width:50px"></div></div>
            <div class="input-row"><label>面板双暴%</label>
                <div><input type="number" id="base_cr" value="60" style="width:48px">% / <input type="number" id="base_cd" value="200" style="width:48px">%</div>
            </div>
            <div class="input-row" style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed rgba(139, 69, 19, 0.2);">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="enable_cr_overflow" style="width: 16px; height: 16px;">
                    <label for="enable_cr_overflow" style="font-size: 12px; color: #8B4513; cursor: pointer;">
                        启用暴击率溢出转换（奥古斯塔2链可启用）
                    </label>
                </div>
            </div>
            <div id="cr_overflow_settings" style="display: none; margin-top: 8px; padding: 8px; background: rgba(139, 69, 19, 0.05); border-radius: 6px;">
                <div class="input-row" style="margin-bottom: 6px;">
                    <label style="font-size: 11px; color: #8B4513;">转换比例：</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <span style="font-size: 11px;">每超出1%暴击率 →</span>
                        <input type="number" id="cr_to_cd_ratio" value="2" min="0" step="0.1" style="width: 40px; font-size: 11px;">%
                        <span style="font-size: 11px;">暴伤</span>
                    </div>
                </div>
                <div class="input-row" style="margin-bottom: 0;">
                    <label style="font-size: 11px; color: #8B4513;">最高提升：</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="number" id="max_cd_gain" value="100" min="0" step="1" style="width: 50px; font-size: 11px;">%
                        <span style="font-size: 11px;">暴伤</span>
                    </div>
                </div>
                <div style="font-size: 10px; color: #8b949e; margin-top: 6px; line-height: 1.3;">
                    说明：暴击率超过100%的部分，按比例转换为暴伤。例如：120%暴击率，超出20%，按2%比例可提升40%暴伤（最高不超过设定上限）。
                </div>
            </div>

            <div style="margin-top:10px; border-top: 1px solid rgba(139, 69, 19, 0.3); padding-top:10px;">
                <h3>面板固定伤害加成</h3>
                <div class="static-bonus-buttons">
                    <button class="btn add-static-bonus-btn" onclick="addStaticBonus()">+ 添加固定加成</button>
                    <button class="btn add-custom-type-btn" onclick="addCustomDamageType()">+ 添加自定义类型</button>
                    <button class="btn manage-custom-types-btn" onclick="showCustomTypes()">📋 管理自定义类型</button>
                </div>
                <div id="static_bonus_list"></div>
            </div>

            <h3>动态 Buff 轨道</h3>
            <div class="buff-group-toolbar">
                <div class="group-selector">
                    <select id="buff_group_select" onchange="changeCurrentGroup(this.value)">
                        <option value="default">默认组</option>
                    </select>
                    <span id="current_group_color" class="group-color-indicator"></span>
                    <button class="btn btn-small" onclick="createNewGroup()">+新建组</button>
                    <button class="btn btn-small" onclick="renameCurrentGroup()">✏️重命名</button>
                    <button class="btn btn-small" onclick="deleteCurrentGroup()">🗑️删除组</button>
                </div>
            </div>
            <div id="buff_pool"></div>
            <button class="btn add-new-buff-btn" onclick="addNewBuff()">+ 新增 Buff</button>
        </div>

        <div class="panel">
            <h2>2. 动作序列</h2>
            <div class="buff-filter">
                <span>BUFF筛选:</span>
                <select id="buff_group_filter" onchange="filterBuffsByGroup(this.value)">
                    <option value="">显示所有组</option>
                </select>
                <button onclick="filterBuffsByGroup('')">显示全部</button>
            </div>
            <div id="action_sequence"></div>
            <div class="add-action-container">
                <h3 class="add-action-title">添加新动作</h3>
                <div class="input-row add-action-inputs">
                    <input type="text" id="act_name" placeholder="动作名称" class="action-name-input">
                    <input type="number" id="act_mult" placeholder="倍率 %" class="action-mult-input">
                    <select id="act_type" class="action-type-select">
                        <!-- 选项将通过JavaScript动态生成 -->
                    </select>
                    <select id="act_scaling" class="action-scaling-select">
                    <option value="atk">攻击力</option>
                    <option value="hp">生命值</option>
                    <option value="def">防御力</option></select>
                    <button class="btn add-action-btn" onclick="addAction()">
                        ✚ 插入动作
                    </button>
                </div>
                <div class="add-action-tip">
                    💡 提示：输入动作名称、倍率百分比并选择类型和基数
                </div>
            </div>
            <button class="btn btn-calc" onclick="calculate()">
                ⚡ 执行分析
            </button>
            <div class="chart-container">
                <canvas id="dmgChart"></canvas>
            </div>

            <!-- 新增：伤害组成表格容器 -->
            <div id="damageComposition" class="damage-composition-container">
                <!-- 伤害组成表格将在这里动态生成 -->
            </div>
        </div>

        <div class="panel">
            <h2>3. 声骸副词条对比</h2>
            <p style="font-size:11px; color:#8b949e;">设置两个声骸的词条，对比其对最终输出的影响</p>

            <div class="echo-box" id="echo_a">
                <div class="echo-header">
                    <h3 class="echo-title echo-a-title">声骸 A</h3>
                    <div class="echo-equipped">
                        <span class="echo-checkbox-label" style="color:#8B4513; font-weight:bold;">默认装备该声骸</span>
                    </div>
                </div>
                <div class="echo-description">
                    副词条类型：普攻/重击/共鸣技能/共鸣解放/暴击/暴伤/攻击%/生命%/防御%等
                </div>
                <div class="substat-container"></div>
                <div class="echo-tips">
                    ✓ 声骸A默认已装备在角色身上<br>
                    ✓ 对比时：计算替换为声骸B的伤害变化
                </div>
            </div>

            <div class="echo-box" id="echo_b">
                <h3 class="echo-title echo-b-title">声骸 B</h3>
                <div class="echo-description echo-b-description">
                    副词条类型：普攻/重击/共鸣技能/共鸣解放/暴击/暴伤/攻击%/生命%/防御%等
                </div>
                <div class="substat-container"></div>
            </div>

            <!-- 声骸B替换影响分析容器 -->
            <div id="detailed_bonus_info" class="detailed-bonus-info">
                <!-- 声骸B替换声骸A的详细影响分析将在这里显示 -->
            </div>
            <div id="compare_res" class="compare-results">
                等待计算...
            </div>
        </div>
    </div>
</div>
<!-- 模块化重构 -->
<script src="js/constants.js"></script>
<script src="js/utils.js"></script>
<script src="js/damageTypes.js"></script>
<script src="js/buffManager.js"></script>
<script src="js/sequenceManager.js"></script>
<script src="js/calculator.js"></script>
<script src="js/staticBonus.js"></script>
<script src="js/echoManager.js"></script>
<script src="js/storage.js"></script>
<script src="js/exportImport.js"></script>
<script src="js/ui.js"></script>
<!-- 其他模块将在后续添加 -->

</body>
</html>
