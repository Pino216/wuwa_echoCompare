<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é¸£æ½®ä¼¤å®³åˆ†æä¸å£°éª¸è¯æ¡å¯¹æ¯”å·¥å…· 1.4</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --bg-light: #f0f4ff; 
            --bg-gradient-start: #e3f2fd; 
            --bg-gradient-end: #fce4ec; 
            --panel: rgba(255, 255, 255, 0.85); 
            --primary: #4a6bff; 
            --accent: #ff6b8b; 
            --text: #333344; 
            --buff: #ff9800; 
            --success: #4caf50; 
            --border: rgba(74, 107, 255, 0.2);
            --shadow: rgba(74, 107, 255, 0.1);
        }
        
        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, 'Microsoft YaHei', sans-serif; 
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end), #e8f5e9);
            color: var(--text); 
            padding: 20px; 
            font-size: 14px; 
            margin: 0;
            min-height: 100vh;
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .container { 
            max-width: 1500px; 
            margin: 0 auto; 
            position: relative;
            z-index: 1;
        }
        
        .grid { 
            display: grid; 
            grid-template-columns: 350px 1fr 450px; 
            gap: 20px; 
        }
        
        .panel { 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 16px; 
            padding: 20px; 
            height: fit-content;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px var(--shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(74, 107, 255, 0.2);
        }
        
        h2 { 
            font-size: 1.2em; 
            color: var(--primary); 
            margin: 0 0 15px 0; 
            border-bottom: 2px solid rgba(74, 107, 255, 0.3); 
            padding-bottom: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        h3 { 
            font-size: 0.95em; 
            margin: 15px 0 10px 0; 
            color: var(--buff); 
            font-weight: 600;
        }
        
        .input-row { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            margin-bottom: 12px; 
        }
        
        input, select { 
            background: rgba(255, 255, 255, 0.9); 
            border: 1px solid rgba(74, 107, 255, 0.3); 
            color: #333; 
            padding: 8px 10px; 
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 13px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.2);
            transform: scale(1.02);
        }

        /* å£°éª¸å¯¹æ¯”æ ·å¼ */
        .echo-box { 
            background: rgba(210, 180, 140, 0.15); 
            border: 1px solid rgba(139, 69, 19, 0.3); 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 15px; 
            backdrop-filter: blur(5px);
        }
        
        .substat-row { 
            display: grid; 
            grid-template-columns: 120px 100px; 
            gap: 10px; 
            margin-bottom: 8px; 
            align-items: center; 
        }

        .action-card { 
            background: rgba(255, 255, 255, 0.9); 
            border: 1px solid rgba(74, 107, 255, 0.3); 
            padding: 12px; 
            margin-bottom: 12px; 
            border-radius: 12px; 
            position: relative;
            transition: all 0.3s ease;
        }
        
        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(74, 107, 255, 0.15);
            border-color: var(--primary);
        }
        
        .chip { 
            background: rgba(139, 69, 19, 0.1); 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 11px; 
            cursor: pointer; 
            margin: 4px; 
            display: inline-block;
            border: 1px solid rgba(139, 69, 19, 0.2);
            color: #8B4513;
            transition: all 0.3s ease;
        }
        
        .chip:hover {
            background: rgba(139, 69, 19, 0.2);
            transform: scale(1.05);
        }
        
        .chip.active { 
            background: #8B4513; 
            color: #fff;
            box-shadow: 0 0 12px rgba(139, 69, 19, 0.4);
        }
        
        .tag-type { 
            background: var(--buff); 
            color: #fff; 
            padding: 2px 8px; 
            border-radius: 6px; 
            font-size: 10px; 
            font-weight: bold;
            margin-left: 8px;
        }

        .btn { 
            cursor: pointer; 
            font-weight: 600; 
            border-radius: 10px; 
            border: none; 
            padding: 8px 16px; 
            transition: all 0.3s ease;
            font-size: 13px;
            background: linear-gradient(135deg, #8B4513, #A0522D);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.3);
        }
        
        .btn:hover { 
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(139, 69, 19, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-calc { 
            background: linear-gradient(135deg, #8B4513, #A0522D); 
            color: #fff; 
            width: 100%; 
            font-size: 1.1em; 
            margin-top: 15px; 
            padding: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .diff-pos { 
            color: #2e7d32; 
            font-weight: bold;
            text-shadow: 0 0 8px rgba(46, 125, 50, 0.2);
        }
        
        .diff-neg { 
            color: #d32f2f; 
            font-weight: bold;
            text-shadow: 0 0 8px rgba(211, 47, 47, 0.2);
        }
        
        /* é¡¶éƒ¨æŒ‰é’®æ ·å¼ */
        .top-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        /* å›¾è¡¨å®¹å™¨ */
        #dmgChart {
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.7);
            padding: 10px;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .container {
                padding: 10px;
            }
        }
        
        /* è£…é¥°æ€§å…ƒç´  */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 107, 139, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(74, 107, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 152, 0, 0.1) 0%, transparent 50%);
            z-index: 0;
            pointer-events: none;
        }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(74, 107, 255, 0.1);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(74, 107, 255, 0.5);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(74, 107, 255, 0.7);
        }
    </style>
</head>
<body>

<div class="container">
    <div class="top-buttons">
        <button class="btn" onclick="exportFullData()" style="background:linear-gradient(135deg, #4a6bff, #6a8bff);">
            ğŸ“¤ å¯¼å‡ºæ–¹æ¡ˆ
        </button>
        <button class="btn" onclick="document.getElementById('csvImport').click()" style="background:linear-gradient(135deg, #ff6b8b, #ff8ba3);">
            ğŸ“¥ å¯¼å…¥æ–¹æ¡ˆ
        </button>
        <input type="file" id="csvImport" style="display:none" onchange="importFullData(this)">
        <button class="btn" onclick="location.reload()" style="background:linear-gradient(135deg, #ff9800, #ffb74d); margin-left:auto;">
            ğŸ”„ é‡ç½®é¡µé¢
        </button>
    </div>

    <div class="grid">
        <div class="panel">
            <h2>1. æ ¸å¿ƒå±æ€§ (é¢æ¿)</h2>
            <div class="input-row"><label>åŸºç¡€ç”Ÿå‘½ / æ€»ç”Ÿå‘½</label>
            <div><input type="number" id="base_hp" value="10000" style="width:50px"> / <input type="number" id="total_hp_now" value="20000" style="width:50px"></div></div>
            <div class="input-row"><label>åŸºç¡€æ”»å‡»(è§’è‰²+æ­¦å™¨)</label><input type="number" id="base_atk" value="1000" style="width:70px"></div>
            <div class="input-row"><label>å½“å‰é¢æ¿æ€»æ”»å‡»</label><input type="number" id="total_atk_now" value="2500" style="width:70px"></div>
            <div class="input-row"><label>åŸºç¡€é˜²å¾¡ / æ€»é˜²å¾¡</label>
            <div><input type="number" id="base_def" value="1000" style="width:50px"> / <input type="number" id="total_def_now" value="1500" style="width:50px"></div></div>
            <div class="input-row"><label>é¢æ¿åŒæš´%</label>
                <div><input type="number" id="base_cr" value="60" style="width:40px">% / <input type="number" id="base_cd" value="200" style="width:40px">%</div>
            </div>

            <div style="margin-top:10px; border-top: 1px solid rgba(139, 69, 19, 0.3); padding-top:10px;">
                <h3>é¢æ¿å›ºå®šä¼¤å®³åŠ æˆ</h3>
                <div id="static_bonus_list"></div>
                <button class="btn" style="width:100%; font-size:11px; background:linear-gradient(135deg, #8B4513, #A0522D); color:#fff;" onclick="addStaticBonus()">+ æ·»åŠ å›ºå®šåŠ æˆ</button>
            </div>

            <h3>åŠ¨æ€ Buff è½¨é“</h3>
            <div id="buff_pool"></div>
            <button class="btn" style="width:100%; background:#30363d; color:#fff;" onclick="addNewBuff()">+ æ–°å¢ Buff</button>
        </div>

        <div class="panel">
            <h2>2. åŠ¨ä½œåºåˆ—</h2>
            <div id="action_sequence" style="max-height: 450px; overflow-y: auto;"></div>
            <div style="background: rgba(210, 180, 140, 0.15); padding: 15px; border-radius: 12px; margin-top:15px; border: 1px solid rgba(139, 69, 19, 0.3);">
                <h3 style="margin-top:0; margin-bottom:10px; color:#8B4513;">æ·»åŠ æ–°åŠ¨ä½œ</h3>
                <div class="input-row" style="flex-wrap:wrap; gap:8px;">
                    <input type="text" id="act_name" placeholder="åŠ¨ä½œåç§°" style="width:100px; flex:1;">
                    <input type="number" id="act_mult" placeholder="å€ç‡ %" style="width:80px; flex:1;">
                    <select id="act_type" style="width:90px; flex:1;">
                        <option value="basic">æ™®æ”»</option><option value="heavy">é‡å‡»</option>
                        <option value="skill">æŠ€èƒ½</option><option value="ult">è§£æ”¾</option><option value="echo">å£°éª¸</option>
                    </select>
                    <select id="act_scaling" style="width:90px; flex:1;">
                    <option value="atk">æ”»å‡»åŠ›</option>
                    <option value="hp">ç”Ÿå‘½å€¼</option>
                    <option value="def">é˜²å¾¡åŠ›</option></select>
                    <button class="btn" style="background:linear-gradient(135deg, #8B4513, #A0522D); color:#fff; flex:1; min-width:100px;" onclick="addAction()">
                        âœš æ’å…¥åŠ¨ä½œ
                    </button>
                </div>
                <div style="font-size:11px; color:#8B4513; margin-top:8px;">
                    ğŸ’¡ æç¤ºï¼šè¾“å…¥åŠ¨ä½œåç§°ã€å€ç‡ç™¾åˆ†æ¯”å¹¶é€‰æ‹©ç±»å‹å’ŒåŸºæ•°
                </div>
            </div>
            <button class="btn btn-calc" onclick="calculate()">
                âš¡ æ‰§è¡Œå…¨é‡åŒ–åˆ†æ
            </button>
            <div style="height: 280px; margin-top:20px; background:rgba(210, 180, 140, 0.15); border-radius:12px; padding:15px; border:1px solid rgba(139, 69, 19, 0.3);">
                <canvas id="dmgChart"></canvas>
            </div>
        </div>

        <div class="panel">
            <h2>3. å£°éª¸å‰¯è¯æ¡å¯¹æ¯”</h2>
            <p style="font-size:11px; color:#8b949e;">è®¾ç½®ä¸¤ä¸ªå£°éª¸çš„è¯æ¡ï¼Œå¯¹æ¯”å…¶å¯¹æœ€ç»ˆè¾“å‡ºçš„å½±å“</p>

            <div class="echo-box" id="echo_a">
                <h3 style="margin-top:0; color:#8B4513">å£°éª¸ A</h3>
                <div class="substat-container"></div>
            </div>

            <div class="echo-box" id="echo_b">
                <h3 style="margin-top:0; color:#A0522D">å£°éª¸ B</h3>
                <div class="substat-container"></div>
            </div>

            <div id="compare_res" style="background:rgba(210, 180, 140, 0.2); padding:15px; border-radius:12px; border:2px solid rgba(139, 69, 19, 0.4);">
                ç­‰å¾…è®¡ç®—...
            </div>
        </div>
    </div>
</div>

<script>
    const SUBSTAT_DATA = {
        "none": { name: "(æ— )", values: [0] },
        "cr": { name: "æš´å‡»ç‡", type: "cr", isPct: true, values: [10.5, 9.9, 9.3, 8.7, 8.1, 7.5, 6.9, 6.3] },
        "cd": { name: "æš´å‡»ä¼¤å®³", type: "cd", isPct: true, values: [21.0, 19.8, 18.6, 17.4, 16.2, 15.0, 13.8, 12.6] },
        "atk_pct": { name: "ç™¾åˆ†æ¯”æ”»å‡»", type: "atk_pct", isPct: true, values: [11.6, 10.9, 10.1, 9.4, 8.6, 7.9, 7.1, 6.4] },
        "atk_flat": { name: "å›ºå®šæ”»å‡»", type: "atk_flat", isPct: false, values: [60, 50, 40, 30] },
        "basic": { name: "æ™®æ”»åŠ æˆ", type: "basic", isPct: true, values: [11.6, 10.9, 10.1, 9.4, 8.6, 7.9, 7.1, 6.4] },
        "heavy": { name: "é‡å‡»åŠ æˆ", type: "heavy", isPct: true, values: [11.6, 10.9, 10.1, 9.4, 8.6, 7.9, 7.1, 6.4] },
        "skill": { name: "æŠ€èƒ½åŠ æˆ", type: "skill", isPct: true, values: [11.6, 10.9, 10.1, 9.4, 8.6, 7.9, 7.1, 6.4] },
        "ult": { name: "è§£æ”¾åŠ æˆ", type: "ult", isPct: true, values: [11.6, 10.9, 10.1, 9.4, 8.6, 7.9, 7.1, 6.4] },
        "eff": { name: "å…±é¸£æ•ˆç‡", type: "other", isPct: true, values: [12.4, 11.6, 10.8, 10.0, 9.2, 8.4, 7.6, 6.8] },
        "hp_pct": { name: "ç™¾åˆ†æ¯”ç”Ÿå‘½", type: "other", isPct: true, values: [11.6, 10.9, 10.1, 9.4, 8.6, 7.9, 7.1, 6.4] },
        "hp_flat": { name: "å›ºå®šç”Ÿå‘½", type: "other", isPct: false, values: [580, 540, 510, 470, 430, 390, 360, 320] },
        "def_pct": { name: "ç™¾åˆ†æ¯”é˜²å¾¡", type: "other", isPct: true, values: [14.7, 13.8, 12.8, 11.8, 10.9, 10.0, 9.0, 8.1] },
        "def_flat": { name: "å›ºå®šé˜²å¾¡", type: "other", isPct: false, values: [70, 60, 50, 40] }
    };
        
    // æ·»åŠ é¡µé¢åŠ è½½æ—¶çš„è§†è§‰å¢å¼º
    window.onload = () => {
        initEchoSelects('echo_a');
        initEchoSelects('echo_b');
        sequence = [{ name: "æŠ€èƒ½æ¼”ç¤º", mult: 2.5, type: "skill", activeBuffs: [] }];
        renderSequence();
        calculate();
            
        // æ·»åŠ è¾“å…¥æ¡†åŠ¨ç”»æ•ˆæœ
        document.querySelectorAll('input, select').forEach(el => {
            el.addEventListener('focus', function() {
                this.style.transform = 'scale(1.02)';
            });
            el.addEventListener('blur', function() {
                this.style.transform = 'scale(1)';
            });
        });
            
        // æ·»åŠ æ¬¢è¿æç¤º
        setTimeout(() => {
            console.log('ğŸ® é¸£æ½®ä¼¤å®³åˆ†æå·¥å…·å·²å°±ç»ªï¼');
        }, 500);
    };

    let sequence = [];
    let buffPool = [];
    let dmgChart = null;

    // --- åˆå§‹åŒ–å‡½æ•° ---
    window.onload = () => {
        initEchoSelects('echo_a');
        initEchoSelects('echo_b');
        sequence = [{ name: "æŠ€èƒ½æ¼”ç¤º", mult: 2.5, type: "skill", activeBuffs: [] }];
        renderSequence();
        calculate();
    };

    function initEchoSelects(id) {
        const container = document.querySelector(`#${id} .substat-container`);
        for(let i=0; i<5; i++) {
            const row = document.createElement('div');
            row.className = 'substat-row';
            let nameSelect = `<select class="sub-name" onchange="updateSubValues(this)">`;
            for(let key in SUBSTAT_DATA) nameSelect += `<option value="${key}">${SUBSTAT_DATA[key].name}</option>`;
            nameSelect += `</select>`;
            row.innerHTML = nameSelect + `<select class="sub-val"><option value="0">0</option></select>`;
            container.appendChild(row);
        }
    }

    function updateSubValues(selectEl) {
        const valSelect = selectEl.parentElement.querySelector('.sub-val');
        const data = SUBSTAT_DATA[selectEl.value];
        valSelect.innerHTML = data.values.map(v => `<option value="${v}">${v}${data.isPct?'%':''}</option>`).join('');
        calculate();
    }

    // --- Buff æ ¸å¿ƒé€»è¾‘ ---
    function addNewBuff() {
        const fixedId = 'b_' + Date.now();
        const html = `
            <div class="buff-config" data-id="${fixedId}" style="border-left:4px solid var(--primary); background:#0d1117; padding:8px; margin-bottom:5px;">
                <div class="input-row">
                    <input type="text" class="b-name" value="æ–°Buff" style="width:80px" oninput="syncBuffNames('${fixedId}', this.value)">
                    <select class="b-cat" onchange="calculate()">
                        <option value="bonus">ä¼¤å®³åŠ æˆ</option>
                        <option value="deepen">ä¼¤å®³åŠ æ·±</option>
                        <option value="atk_pct">æ”»å‡»%</option>
                        <option value="cr">æš´å‡»ç‡</option>
                        <option value="cd">æš´å‡»ä¼¤å®³</option>
                        <option value="hp_pct">ç”Ÿå‘½%</option>
                        <option value="def_pct">é˜²å¾¡%</option>
                    </select>
                </div>
                <div class="input-row">
                    <select class="b-type" onchange="calculate()">
                        <option value="all">å…¨é€šç”¨</option>
                        <option value="basic">æ™®æ”»</option><option value="skill">æŠ€èƒ½</option>
                        <option value="ult">è§£æ”¾</option><option value="heavy">é‡å‡»</option>
                    </select>
                    <input type="number" class="b-val" value="10" style="width:40px" oninput="calculate()">%
                    <button onclick="this.parentElement.parentElement.remove(); renderSequence(); calculate();" style="color:var(--accent); background:none; border:none; cursor:pointer;">Ã—</button>
                </div>
            </div>`;
        document.getElementById('buff_pool').insertAdjacentHTML('beforeend', html);
        renderSequence();
    }

    function syncBuffNames(id, newName) {
        document.querySelectorAll(`.chip[data-bid="${id}"]`).forEach(chip => {
            chip.innerText = newName;
        });
        updateBuffPool();
    }

    function updateBuffPool() {
        buffPool = [];
        document.querySelectorAll('.buff-config').forEach(el => {
            buffPool.push({
                id: el.dataset.id,
                name: el.querySelector('.b-name').value,
                cat: el.querySelector('.b-cat').value,
                type: el.querySelector('.b-type').value,
                val: parseFloat(el.querySelector('.b-val').value) / 100
            });
        });
    }

    // --- åŠ¨ä½œåºåˆ—é€»è¾‘ ---
function addAction() {
    const name = document.getElementById('act_name').value || "æ–°åŠ¨ä½œ";
    const mult = parseFloat(document.getElementById('act_mult').value) / 100 || 0;
    const type = document.getElementById('act_type').value;

    // è·å–æ–°å¢çš„åŸºæ•°é€‰æ‹©
    const scaling = document.getElementById('act_scaling').value;

    // å°† scaling å­˜å…¥åŠ¨ä½œå¯¹è±¡ä¸­
    sequence.push({
        name,
        mult,
        type,
        scaling, // å­˜å…¥æ­¤å­—æ®µï¼ŒrunSim æ‰èƒ½è¯»å–
        activeBuffs: []
    });

    renderSequence();
    calculate();
}

    function renderSequence() {
        updateBuffPool();
        const container = document.getElementById('action_sequence');
        container.innerHTML = sequence.map((a, i) => `
            <div class="action-card">
                <strong>${a.name}</strong> <span class="tag-type">${a.type}</span>
                <span>${(a.mult*100).toFixed(1)}% (${a.scaling === 'hp' ? 'ç”Ÿå‘½' : a.scaling === 'def' ? 'é˜²å¾¡' : 'æ”»å‡»'})</span>
                <div style="margin-top:6px;">
                    ${buffPool.map(b => `
                        <div class="chip ${a.activeBuffs.includes(b.id) ? 'active' : ''}"
                             data-bid="${b.id}" onclick="toggleBuff(${i}, '${b.id}')">
                            ${b.name}
                        </div>
                    `).join('')}
                </div>
                <span style="position:absolute; right:10px; top:10px; cursor:pointer; color:var(--accent)" onclick="sequence.splice(${i},1);renderSequence();calculate();">Ã—</span>
            </div>
        `).join('');
    }

    function toggleBuff(actIdx, buffId) {
        const bIdx = sequence[actIdx].activeBuffs.indexOf(buffId);
        if(bIdx > -1) sequence[actIdx].activeBuffs.splice(bIdx, 1);
        else sequence[actIdx].activeBuffs.push(buffId);
        renderSequence();
        calculate();
    }

    // --- è®¡ç®—é€»è¾‘ ---
function runSim(extraSubs = []) {
    updateBuffPool();

    // 1. è·å–åŸºç¡€é¢æ¿æ•°æ®
    const baseAtk = parseFloat(document.getElementById('base_atk').value) || 0;
    const totalAtkNow = parseFloat(document.getElementById('total_atk_now').value) || 0;
    const baseHp = parseFloat(document.getElementById('base_hp')?.value) || 0;
    const totalHpNow = parseFloat(document.getElementById('total_hp_now')?.value) || 0;
    const baseDef = parseFloat(document.getElementById('base_def')?.value) || 0;
    const totalDefNow = parseFloat(document.getElementById('total_def_now')?.value) || 0;

    const panelCr = parseFloat(document.getElementById('base_cr').value) / 100 || 0;
    const panelCd = parseFloat(document.getElementById('base_cd').value) / 100 || 0;

    // 2. å›ºå®šåŠ æˆ (æ¥è‡ªé™æ€åˆ—è¡¨)
    let staticBonusMap = { basic:0, heavy:0, skill:0, ult:0, echo:0, all:0 };
    document.querySelectorAll('.static-bonus-item').forEach(el => {
        staticBonusMap[el.querySelector('.s-type').value] += parseFloat(el.querySelector('.s-val').value)/100;
    });

    // 3. å¤„ç†å‰¯è¯æ¡åŠ æˆ (éœ€å¢åŠ ç”Ÿå‘½å’Œé˜²å¾¡å±æ€§è¯†åˆ«)
    let subValues = { atk_pct: 0, hp_pct: 0, def_pct: 0, cr: 0, cd: 0 };
    let subBonus = { basic:0, heavy:0, skill:0, ult:0, echo:0 };

    extraSubs.forEach(s => {
        const d = SUBSTAT_DATA[s.key];
        if(!d) return;
        const v = s.val / 100;
        if(subValues[d.type] !== undefined) subValues[d.type] += v;
        else if(subBonus[d.type] !== undefined) subBonus[d.type] += v;
    });

    let typeDmg = { basic:0, heavy:0, skill:0, ult:0, echo:0 };
    let totalDmg = 0;

    // 4. éå†åŠ¨ä½œåºåˆ—è®¡ç®—
    sequence.forEach(a => {
        // æ ¹æ®åŠ¨ä½œè®¾å®šçš„åŸºæ•°(scaling)åˆå§‹åŒ–åŸºç¡€å€¼
        let baseStat = baseAtk;
        let currentTotalStat = totalAtkNow;
        let scalingAttrKey = 'atk_pct'; // å¯¹åº”çš„ç™¾åˆ†æ¯”Buffåˆ†ç±»

        if (a.scaling === 'hp') {
            baseStat = baseHp;
            currentTotalStat = totalHpNow;
            scalingAttrKey = 'hp_pct';
        } else if (a.scaling === 'def') {
            baseStat = baseDef;
            currentTotalStat = totalDefNow;
            scalingAttrKey = 'def_pct';
        }

        let curAttrPct = subValues[scalingAttrKey]; // å½“å‰åŠ¨ä½œå¯¹åº”å±æ€§çš„å‰¯è¯æ¡åŠ æˆ
        let curCr = panelCr + subValues.cr;
        let curCd = panelCd + subValues.cd;
        let curBonus = 1 + staticBonusMap.all + staticBonusMap[a.type] + (subBonus[a.type] || 0);
        let curDeepen = 1;

        // 5. åº”ç”¨åŠ¨æ€ Buff
        a.activeBuffs.forEach(bid => {
            const b = buffPool.find(x => x.id === bid);
            if(b && (b.type === 'all' || b.type === a.type)) {
                if(b.cat === 'bonus') curBonus += b.val;
                else if(b.cat === 'deepen') curDeepen += b.val;
                else if(b.cat === scalingAttrKey) curAttrPct += b.val; // ä»…åº”ç”¨åŒ¹é…åŸºæ•°çš„å±æ€§Buff
                else if(b.cat === 'cr') curCr += b.val;
                else if(b.cat === 'cd') curCd += b.val;
            }
        });

        // æœ€ç»ˆå±æ€§è®¡ç®—ï¼šå½“å‰é¢æ¿ + (åŸºç¡€å±æ€§ * é¢å¤–ç™¾åˆ†æ¯”åŠ æˆ)
        const finalScalingValue = currentTotalStat + (baseStat * curAttrPct);
        const critExp = 1 + Math.min(1, curCr) * (curCd - 1);

        // æ ¸å¿ƒä¼¤å®³å…¬å¼
        const dmg = finalScalingValue * a.mult * curBonus * curDeepen * critExp;

        typeDmg[a.type] += dmg;
        totalDmg += dmg;
    });

    return { totalDmg, typeDmg };
}

    function calculate() {
        const getEchoSubs = (id) => {
            const subs = [];
            document.querySelectorAll(`#${id} .substat-row`).forEach(row => {
                subs.push({ key: row.querySelector('.sub-name').value, val: parseFloat(row.querySelector('.sub-val').value) || 0 });
            });
            return subs;
        };

        const resBase = runSim([]);
        const resA = runSim(getEchoSubs('echo_a'));
        const resB = runSim(getEchoSubs('echo_b'));

        updateChart(resBase.typeDmg);

        const gainA = (resA.totalDmg / resBase.totalDmg - 1) * 100;
        const gainB = (resB.totalDmg / resBase.totalDmg - 1) * 100;
        const diff = gainA - gainB;

        document.getElementById('compare_res').innerHTML = `
            <div style="margin-bottom:5px;">å£°éª¸ A æå‡: <span class="diff-pos">+${gainA.toFixed(2)}%</span></div>
            <div style="margin-bottom:8px;">å£°éª¸ B æå‡: <span class="diff-pos">+${gainB.toFixed(2)}%</span></div>
            <div style="border-top:1px dashed #555; padding-top:8px; font-weight:bold; font-size:1.1em;">
                ç»“è®º: ${diff > 0 ? `å£°éª¸ A å¼º <span class="diff-pos">${diff.toFixed(2)}%</span>` : `å£°éª¸ B å¼º <span class="diff-neg">${Math.abs(diff).toFixed(2)}%</span>`}
            </div>
        `;
    }

    // --- é€šç”¨è¾…åŠ© ---
function updateChart(typeDmg) {
    const ctx = document.getElementById('dmgChart').getContext('2d');
    if (dmgChart) dmgChart.destroy();

    // è®¡ç®—æ€»ä¼¤å®³ï¼Œç”¨äºè®¡ç®—ç™¾åˆ†æ¯”
    const total = Object.values(typeDmg).reduce((a, b) => a + b, 0);
    const labels = ['æ™®æ”»', 'é‡å‡»', 'æŠ€èƒ½', 'è§£æ”¾', 'å£°éª¸'];
    const dataValues = [typeDmg.basic, typeDmg.heavy, typeDmg.skill, typeDmg.ult, typeDmg.echo];

    dmgChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: dataValues,
                backgroundColor: ['#58a6ff', '#ff7b72', '#d29922', '#bc8cff', '#30363d'],
                borderWidth: 0
            }]
        },
options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            position: 'right',
            labels: {
                // 1. è®¾ç½®åŸºç¡€é¢œè‰²ï¼ˆä½œä¸ºåå¤‡ï¼‰
                color: '#ffffff',
                font: { size: 12, weight: 'bold' },
                generateLabels: function(chart) {
                    const data = chart.data;
                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                    if (data.labels.length && data.datasets.length) {
                        return data.labels.map((label, i) => {
                            const value = data.datasets[0].data[i];
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : "0.0";
                            return {
                                text: `${label}: ${percentage}%`,
                                fillStyle: data.datasets[0].backgroundColor[i],
                                // 2. å…³é”®ï¼šåœ¨ç”Ÿæˆçš„æ ‡ç­¾å¯¹è±¡ä¸­å¼ºåˆ¶æŒ‡å®šæ–‡å­—é¢œè‰²ä¸ºç™½è‰²
                                fontColor: '#ffffff',
                                // å…¼å®¹æ€§å¤„ç†ï¼šéƒ¨åˆ†ç‰ˆæœ¬å¯èƒ½è¯†åˆ« color å±æ€§
                                color: '#ffffff',
                                hidden: isNaN(data.datasets[0].data[i]) || chart.getDatasetMeta(0).data[i].hidden,
                                index: i
                            };
                        });
                    }
                    return [];
                }
            }
        },
        tooltip: {
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            callbacks: {
                label: function(context) {
                    const value = context.raw;
                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                    return `ä¼¤å®³: ${value.toFixed(0)} (${percentage}%)`;
                }
            }
        }
    }
}
    });
}

    function addStaticBonus() {
        const html = `<div class="static-bonus-item input-row">
            <select class="s-type" onchange="calculate()"><option value="all">å…¨å±æ€§</option><option value="basic">æ™®æ”»</option><option value="heavy">é‡å‡»</option><option value="skill">æŠ€èƒ½</option><option value="ult">è§£æ”¾</option></select>
            <input type="number" class="s-val" value="30" style="width:40px" oninput="calculate()">%
            <button onclick="this.parentElement.remove(); calculate();" style="color:var(--accent); background:none; border:none;">Ã—</button>
        </div>`;
        document.getElementById('static_bonus_list').insertAdjacentHTML('beforeend', html);
        calculate();
    }

    function exportFullData() {
        updateBuffPool();
        const config = {
            base_atk: document.getElementById('base_atk').value,
            total_atk_now: document.getElementById('total_atk_now').value,
            base_cr: document.getElementById('base_cr').value,
            base_cd: document.getElementById('base_cd').value,
            buffs: buffPool,
            sequence: sequence
        };
        const blob = new Blob(["\ufeff" + JSON.stringify(config)], { type: 'application/json' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `é¸£æ½®åˆ†æ_${new Date().getTime()}.json`;
        link.click();
    }

    function importFullData(input) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = JSON.parse(e.target.result);
            document.getElementById('base_atk').value = data.base_atk;
            document.getElementById('total_atk_now').value = data.total_atk_now;
            document.getElementById('base_cr').value = data.base_cr;
            document.getElementById('base_cd').value = data.base_cd;
            sequence = data.sequence;
            renderSequence();
            calculate();
        };
        reader.readAsText(input.files[0]);
    }
</script>
</body>
</html>
